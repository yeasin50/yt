<div class="course-sidebar">
  <div class="sidebar-header">
    <h3>Course Menu</h3>
    <button class="close-btn" onclick="closeSidebar()">✕</button>
  </div>

  <ul class="sidebar-list">
    {{ $current := . }}
    {{ $root := .CurrentSection.Parent | default .CurrentSection }}

    {{/* --- Hybrid sorting for folders --- */}}
    {{ $numbered := slice }}
    {{ $unnumbered := slice }}
    {{ range $root.Sections }}
      {{ if findRE "^[0-9]+" .Title }}
        {{ $numbered = $numbered | append . }}
      {{ else }}
        {{ $unnumbered = $unnumbered | append . }}
      {{ end }}
    {{ end }}
    {{ $numbered = sort $numbered "Title" }}
    {{ $unnumbered = sort $unnumbered "Weight" }}
    {{ $sections := append $numbered $unnumbered }}

    {{ range $sections }}
      {{ $isActive := in $current.RelPermalink .RelPermalink }}
      <li class="sidebar-folder">
        <button class="folder-toggle" data-title="{{ .Title }}" onclick="toggleFolder(this)">
          {{ if $isActive }}▼{{ else }}▶{{ end }} {{ .Title }}
        </button>

        <ul class="sidebar-sublist" style="display:{{ if $isActive }}block{{ else }}none{{ end }};">
          {{ $numPages := slice }}
          {{ $weightedPages := slice }}
          {{ range .Pages }}
            {{ if findRE "^[0-9]+" .File.BaseFileName }}
              {{ $numPages = $numPages | append . }}
            {{ else }}
              {{ $weightedPages = $weightedPages | append . }}
            {{ end }}
          {{ end }}
          {{ $numPages = sort $numPages "File.BaseFileName" }}
          {{ $weightedPages = sort $weightedPages "Weight" }}
          {{ $allPages := append $numPages $weightedPages }}

          {{ range $allPages }}
            <li>
              <a href="{{ .RelPermalink }}" {{ if eq .Permalink $current.Permalink }}class="active"{{ end }}>
                {{ .Title }}
              </a>
            </li>
          {{ end }}
        </ul>
      </li>
    {{ end }}
  </ul>
</div>

<script>
function toggleFolder(btn) {
  const sublist = btn.nextElementSibling;
  if (!sublist) return;
  const isVisible = sublist.style.display !== "none";
  const title = btn.dataset.title;
  btn.textContent = (isVisible ? "▶ " : "▼ ") + title;
  sublist.style.display = isVisible ? "none" : "block";
}

// Initialize arrows on page load
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".folder-toggle").forEach(btn => {
    const title = btn.dataset.title;
    btn.textContent = "▶ " + title;
  });
});
</script>
